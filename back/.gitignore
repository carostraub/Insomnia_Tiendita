import os
from dotenv import load_dotenv
import cloudinary.uploader
from flask_cors import cross_origin, CORS
from flask import Blueprint, request, jsonify
from werkzeug.utils import secure_filename
from werkzeug.security import generate_password_hash
from flask_jwt_extended import jwt_required, create_access_token, get_jwt_identity
from models  import db, product_category, Product, Category,Client, Address, Order, OrderDetail, Review, Coupon
#falta hacer decorador y config imagenes

api = Blueprint("api", __name__)
load_dotenv()

@api.route('/register', methods=['POST'])
def register():
    email = request.form.get("email")
    password = request.form.get("password")
    name = request.form.get("name")
    subscribe = request.form.get("subscribe", "false").lower() == "true"

    if not all([email, password, name]):
        return jsonify({"error":"Hay que completar todos los campos obligatorios"}), 400
    if Client.query.filter_by(email=email).first():
        return jsonify({"error":"Este mail ya esta registrado"}), 409
    
    is_admin = False
    if email == os.getenv("ADMIN_EMAIL") and password == os.getenv("ADMIN_PASSWORD"):
        is_admin = True
    else:
        return jsonify({"error":"Credenciales incorrectas para Admin"})
    
    client = Client(
        email = email,
        name = name,
        subscribe = subscribe,
        admin = is_admin
    )
    client.set_password(password)

    try: 
        db.session.add(client)
        db.session.commit()
        access_token = create_access_token(identity=client.id)

        return jsonify({
            "message": "Bienvenido al club de Insomnia Tiendita",
            "client": client.serialize(),
            "access_token": access_token
        }), 201
    except Exception as e:
        db.session.rollback()
        app.logger.error(f"Error en registro: {str(e)}")
        return jsonify({"error":"Error en el servidor"}), 500
    